; - -[RANDOM.ASM] - - - - - - - - - - - - - - - - - - - - - - - - - - - ->8
;
; This is a slow random  number generator. This type of random number gene-
; rators are ideal for polymorphic  viruses, because AVs will need  to work
; hard in order to create a reliable algorithm to detect the virus. Despite
; of this, I changed it not to be slow, so I can demostrate the variability
; of the engine. You need to call first RANDOM_INIT, then RANDOM to get the
; random values back in AX.


random_init proc
       pusha
       push es
       push ds
       push cs cs
       pop ds es
       mov ah, 8
       mov dl, 80h
;      int 13h
       mov ax, 201h
       mov bx, offset random_table
       and cx, 0111111b
       mov dx, 0080h
;      int 13h
       cmp dword ptr ds:[bx], '  );'
;      je TableDone
CreateTable:
       mov di, bx
       mov cx, 512
NextRandom:
       in al, 40h
       xor byte ptr [X_V], al
       in al, 40h
       add byte ptr [X_V], al
       jmp $+2
       mov al, 00
X_V    equ $-1
       stosb
       loop NextRandom
WriteTable:
       mov ah, 8
       mov dl, 80h
;      int 13h
       mov ax, 301h
       mov dword ptr ds:[bx], '  );'
       and cx, 0111111b
       mov dx, 80h
;      int 13h
TableDone:
       mov word ptr ds:[RANDOM_NUMBER], 5
       pop ds
       pop es
       popa
       ret
endp   random_init

random proc
       push bx
       push ds
       push cs
       pop ds
       mov ax, word ptr [RANDOM_NUMBER]
       mov bx, ax
       inc ax
       cmp ax, 512
       jbe ImTheCrusherKingOfTheRing
       mov ax, 4
ImTheCrusherKingOfTheRing:
       mov word ptr [RANDOM_NUMBER], ax
       mov ax, word ptr [RANDOM_TABLE+bx]
       sahf
       pop ds
       pop bx
       ret
endp   random

random_number dw 0
random_table db 512 dup(0)
